var A=Symbol("Input Layer"),x=Symbol("Action Layer"),R=Symbol("Change Action"),T=(I=>(I.REGISTER_INPUT="antetype.conditions.input.register",I.REGISTER_METHOD="antetype.conditions.method.register",I))(T||{});function S({inputsMap:t,inputsTypeMap:p,methodsMap:I,modules:f}){let y=e=>I[e]??null,C=(e,n)=>{let i=n[R]?.changes??[];for(let a=0;a<i.length;a++)if(i[a]===n){i.splice(a,1);break}for(let a=0;a<e.changes.length;a++)if(e.changes[a]===n){e.changes.splice(a,1);break}},h=(e,n)=>{let i={[R]:e,type:n.type,arguments:[...n.arguments??[]]};return e.changes.push(i),i},m=(e,n)=>{let i=n[x]?.conditions?.actions??[];for(let a=0;a<i.length;a++)if(i[a]===n){i.splice(a,1);break}for(let a=0;a<e.length;a++)if(e[a]===n){e.splice(a,1);break}},g=e=>{e.conditions??={},e.conditions.actions??=[];let n={[x]:e,rule:{text:""},changes:[]};return e.conditions.actions.push(n),n},d=(e,n)=>{n.id=f.core.meta.generateId(),n[A]=e,t[n.id]=n},o=(e,n)=>{let i=n.generate(e);return d(e,i),e.conditions??={},e.conditions.inputs??=[],e.conditions.inputs.push(i),i},l=e=>{let n=e[A]?.conditions?.inputs??[];for(let i=0;i<n.length;i++)if(n[i]===e){n.splice(i,1);break}e.id&&delete t[e.id]},u=e=>t[e]??null,c=e=>e[A]??null,r=()=>Object.values(t),s=e=>p[e]??null,b=e=>{let n=e.conditions?.inputs??[];for(let i=0;i<n.length;i++){let a=n[i];if(a[A]){t[a.id]=a;continue}let v=s(a.type);if(v){let E=v.generate(e);for(let D in a)E[D]=a[D];n[i]=a=E}a.id??=f.core.meta.generateId(),t[a.id]??=a,a[A]??=f.core.clone.getOriginal(e)}for(let i of e.layout??[])b(i)},M=e=>{for(let n of e.conditions?.actions??[])if(!n[x]){n[x]=e;for(let i of n.changes)i[R]=n}for(let n of e.layout??[])M(n)};return{addInput:o,removeInput:l,getInputByType:s,getInputById:u,getInputs:r,getInputLayer:c,addEmptyAction:g,removeAction:m,addChange:h,removeChange:C,getMethod:y,registerInput:d,registerNewInputs:b,registerNewActions:M}}var w={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"},K=Symbol("original"),Q=Symbol("clone");var X=Symbol("layer");var V="core",B="0.0.5",Z=class{#e;#t=null;#n=!1;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#e=t}async loadModules(t){return(await this.#i()).loadModules(t)}register(t){let{registration:p}=t.detail;p[V]={load:async()=>(!this.#t&&!this.#n&&(this.#n=new Promise(I=>{this.#o("core.js").then(f=>{this.#t=f.default,this.#n=!1,I()})})),this.#n&&await this.#n,I=>this.#t({modules:I,herald:this.#e.herald})),version:B}}static subscriptions={[w.MODULES]:"register"};#o(t){return import(this.#e.marshal.getResourceUrl(this,t))}async#i(){return this.#r??=(await this.#o("helper.js")).default,new this.#r(this.#e.herald)}};function k({modules:t,herald:p,crud:I,inputsTypeMap:f,methodsMap:y,additional:C}){let h=async()=>{let o={},l=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:o}});await p.dispatch(l,{origin:t.core.meta.getCanvas()});for(let u in f)delete f[u];for(let u in l.detail.inputs){let c=l.detail.inputs[u];f[c.type]=c}return l.detail.inputs},m=async()=>{let o={},l=new CustomEvent("antetype.conditions.method.register",{detail:{methods:o}});await p.dispatch(l,{origin:t.core.meta.getCanvas()});for(let u in y)delete y[u];for(let u in l.detail.methods){let c=l.detail.methods[u];y[c.type]=c}return l.detail.methods},g={},d=(o=null)=>{o??=t.core.meta.getCanvas();let l=p.batch([{event:w.CLOSE,subscription:()=>{l()},anchor:o},{event:w.CANVAS_CHANGE,subscription:({detail:{current:u}})=>{l(),d(u)},anchor:o},{event:w.INIT,subscription:{method:async u=>{await Promise.all([h(),m()]);let{base:c}=u.detail;for(let r of c)I.registerNewInputs(r),I.registerNewActions(r)},priority:-10,anchor:o}},{event:"antetype.conditions.input.register",subscription:u=>{let{inputs:c}=u.detail;c.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},c.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(r){if(r===null){for(let s of this.options)s.checked=!1;return}for(let s of this.options)r==s.value?s.checked=!0:s.checked=!1},get value(){for(let r of this.options)if(r.checked)return r.value;return null},options:[]})},c.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(r){if(r===null){for(let s of this.options)s.checked=!1;return}for(let s of this.options)r.indexOf(s.value)!==-1?s.checked=!0:s.checked=!1},get value(){let r=[];for(let s of this.options)s.checked&&r.push(s.value);return r},options:[]})},c.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}},anchor:o},{event:"antetype.conditions.method.register",subscription:u=>{let{methods:c}=u.detail;c.hide={name:"Hide layer",type:"hide",resolve:({event:r})=>{r.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}}}},c.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:r},s)=>{if(!s||r.type!=="image")return;r.image.src=s;let b=t.core.clone.getOriginal(r);if(g[s]?.has(b))return;g[s]??=new WeakMap,g[s].set(b,!0);let M=new Image;M.onload=function(){t.core.view.recalculate().then(()=>{t.core.view.redraw()})},M.src=s}},c.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:r},s)=>{!s||r.type!=="text"||(r.text.value=s)}},c.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:r},s,b)=>{if(!s)return;let M=(n,i,a,v=0)=>{if(i.length==v+1){n[i[v]]=a;return}let E=typeof n[i[v]];if(E!="undefined"&&E!="object"&&n[i[v]]!==null){console.error("Cannot replace scalar value with object by template actions",n,i,a);return}n[i[v]]??={},M(n[i[v]],i,a,v+1)},e=s.split(".");M(r,e,b)}}},anchor:o},...C.reduce((u,c)=>[...u,...c(o)],[])])};return d(),{retrieveInputs:h,retrieveMethods:m}}function P({crud:t,enableTextConditions:p}){let I={},f=h=>{let m=[];for(let g of h){let d=g.value;g.inputId&&(d=t.getInputById(g.inputId)?.value??null),m.push(d)}return m},y=(h,m=null)=>{let g=h.rule.text.trim();return!p||g.length==0?!0:(m??=C(),I[g]||(I[g]=new Function(...Object.keys(m),"return !!("+g+")").bind({})),I[g](...Object.values(m)))},C=()=>{let h={};for(let m of t.getInputs())h[m.name]=m.value,h[m.id]=m.value;return{inputs:h}};return{props:{canActionResolve:y,generateActionArguments:C,resolveArguments:f},events:(h=null)=>[{event:w.CALC,subscription:{method:m=>{let g=m.detail.element;if(!g?.conditions?.actions||g.conditions.actions.length==0)return;let d=C();for(let o of g.conditions.actions){try{if(!y(o,d))continue}catch{continue}for(let l of o.changes){let u=t.getMethod(l.type);u&&u.resolve({layer:g,event:m},...f(l.arguments))}}},priority:-250,anchor:h}}]}}function H({modules:t}){let p=null,I=1.2*10**5,f=d=>{if(!p){p={};for(let o of t.conditions.getInputs())p[o.name]=o}return p[d]??null},y=(d,o)=>{let l={...o};for(let u of t.conditions.getInputs())u.id in o||u.name in o||(l[u.id]=JSON.stringify(d[u.id]));return l},C=(d,o,l)=>{let u=setTimeout(()=>{d(null)},I),c=y(l,o.values);for(let r in c){if(!Object.hasOwn(c,r))continue;let s=c[r],b=t.conditions.getInputById(r)??f(r);if(b){try{b.value=JSON.parse(s)}catch{b.value=s}t.core.clone.getClone(b).value=b.value}}t.workspace.export(o.settings).then(r=>{d(URL.createObjectURL(r)),clearTimeout(u)})},h=(d,o)=>{let l=[],u=new Promise(c=>{c(null)});for(let c of o)u=new Promise(r=>{u.then(()=>{C(r,c,d)})}),l.push(u);return l},m=async d=>{for(let o in d){if(!Object.hasOwn(d,o))continue;let l=t.conditions.getInputById(o);l&&(l.value=t.core.clone.getClone(l).value=d[o])}await t.core.view.recalculate(),t.core.view.redraw()};return{bulkGenerate:d=>{let o=t.conditions.getInputs().reduce((r,s)=>(r[s.id]=s.value,r),{}),l=t.core.setting,u=l.get("illustrator.image.waitForLoad");l.set("illustrator.image.waitForLoad",!0);let c=h(o,d);return Promise.all(c).then(()=>{l.set("illustrator.image.waitForLoad",u),m(o)}),c}}}function O({herald:t,modules:p}){let I={},f={},y={},C=S({inputsMap:I,inputsTypeMap:f,methodsMap:y,modules:p}),h=H({modules:p,herald:t}),m=()=>{try{return new Function("return 1"),!0}catch(l){return/unsafe-eval|CSP/.exec(l.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},{props:g,events:d}=P({enableTextConditions:m(),inputsMap:I,herald:t,modules:p,crud:C}),o=k({inputsMap:I,herald:t,modules:p,inputsTypeMap:f,methodsMap:y,crud:C,additional:[d]});return{getInputsMap:()=>({...f}),getMethodsMap:()=>({...y}),...o,...C,...g,...h}}var L="conditions",j="0.0.4",N=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(p){this.#e=p}register(p){let{registration:I}=p.detail;I[L]={load:async()=>{if(!this.#t){let f=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(f)).default}return f=>this.#t({modules:f,herald:this.#e.herald})},version:j}}static subscriptions={[w.MODULES]:"register"}};export{O as Conditions,T as Event,L as ID,j as VERSION,x as actionLayerSymbol,R as changeActionSymbol,A as inputLayerSymbol};
