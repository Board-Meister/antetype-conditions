var b=Symbol("Input Layer"),M=Symbol("Action Layer"),E=Symbol("Change Action"),P=(d=>(d.REGISTER_INPUT="antetype.conditions.input.register",d.REGISTER_METHOD="antetype.conditions.method.register",d))(P||{});function R({inputsMap:c,inputsTypeMap:p,methodsMap:d,modules:u}){let I=e=>d[e]??null,g=(e,t)=>{let s=t[E]?.changes??[];for(let a=0;a<s.length;a++)if(s[a]===t){s.splice(a,1);break}for(let a=0;a<e.changes.length;a++)if(e.changes[a]===t){e.changes.splice(a,1);break}},f=(e,t)=>{let s={[E]:e,type:t.type,arguments:[...t.arguments??[]]};return e.changes.push(s),s},h=(e,t)=>{let s=t[M]?.conditions?.actions??[];for(let a=0;a<s.length;a++)if(s[a]===t){s.splice(a,1);break}for(let a=0;a<e.length;a++)if(e[a]===t){e.splice(a,1);break}},l=e=>{e.conditions??={},e.conditions.actions??=[];let t={[M]:e,rule:{text:""},changes:[]};return e.conditions.actions.push(t),t},i=(e,t)=>{t.id=u.core.meta.generateId(),t[b]=e,c[t.id]=t},r=(e,t)=>{let s=t.generate(e);return i(e,s),e.conditions??={},e.conditions.inputs??=[],e.conditions.inputs.push(s),s},n=e=>{let t=e[b]?.conditions?.inputs??[];for(let s=0;s<t.length;s++)if(t[s]===e){t.splice(s,1);break}e.id&&delete c[e.id]},o=e=>c[e]??null,y=e=>e[b]??null,C=()=>Object.values(c),x=e=>p[e]??null,v=e=>{let t=e.conditions?.inputs??[];for(let s=0;s<t.length;s++){let a=t[s];if(a[b])continue;let w=x(a.type);if(w){let D=w.generate(e);for(let T in a)D[T]=a[T];t[s]=a=D}a.id||(a.id=u.core.meta.generateId()),c[a.id]=a,a[b]=e}for(let s of e.layout??[])v(s)},m=e=>{for(let t of e.conditions?.actions??[])if(!t[M]){t[M]=e;for(let s of t.changes)s[E]=t}for(let t of e.layout??[])m(t)};return{addInput:r,removeInput:n,getInputByType:x,getInputById:o,getInputs:C,getInputLayer:y,addEmptyAction:l,removeAction:h,addChange:f,removeChange:g,getMethod:I,registerInput:i,registerNewInputs:v,registerNewActions:m}}var A={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};function S({modules:c,herald:p,crud:d,inputsTypeMap:u,methodsMap:I}){let g=async()=>{let i={},r=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:i}});await p.dispatch(r);for(let n in u)delete u[n];for(let n in r.detail.inputs){let o=r.detail.inputs[n];u[o.type]=o}return r.detail.inputs},f=async()=>{let i={},r=new CustomEvent("antetype.conditions.method.register",{detail:{methods:i}});await p.dispatch(r);for(let n in I)delete I[n];for(let n in r.detail.methods){let o=r.detail.methods[n];I[o.type]=o}return r.detail.methods},h={},l=p.batch([{event:A.CLOSE,subscription:()=>{l()}},{event:A.INIT,subscription:{method:async i=>{await Promise.all([g(),f()]);let{base:r}=i.detail;for(let n of r)d.registerNewInputs(n),d.registerNewActions(n)},priority:-10}},{event:"antetype.conditions.input.register",subscription:i=>{let{inputs:r}=i.detail;r.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},r.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(n){if(n===null){for(let o of this.options)o.checked=!1;return}for(let o of this.options)n==o.value?o.checked=!0:o.checked=!1},get value(){for(let n of this.options)if(n.checked)return n.value;return null},options:[]})},r.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(n){if(n===null){for(let o of this.options)o.checked=!1;return}for(let o of this.options)n.indexOf(o.value)!==-1?o.checked=!0:o.checked=!1},get value(){let n=[];for(let o of this.options)o.checked&&n.push(o.value);return n},options:[]})},r.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}}},{event:"antetype.conditions.method.register",subscription:i=>{let{methods:r}=i.detail;r.hide={name:"Hide layer",type:"hide",resolve:({event:n})=>{n.detail.element=null}},r.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:n},o)=>{if(!o||n.type!=="image")return;n.image.src=o;let y=c.core.clone.getOriginal(n);if(h[o]?.has(y))return;h[o]??=new WeakMap,h[o].set(y,!0);let C=new Image;C.onload=function(){c.core.view.recalculate().then(()=>{c.core.view.redraw()})},C.src=o}},r.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:n},o)=>{!o||n.type!=="text"||(n.text.value=o)}},r.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:n},o,y)=>{if(!o)return;let C=(v,m,e,t=0)=>{if(m.length==t+1){v[m[t]]=e;return}let s=typeof v[m[t]];if(s!="undefined"&&s!="object"&&v[m[t]]!==null){console.error("Cannot replace scalar value with object by template actions",v,m,e);return}v[m[t]]??={},C(v[m[t]],m,e,t+1)},x=o.split(".");C(n,x,y)}}}}]);return{retrieveInputs:g,retrieveMethods:f}}function H({herald:c,crud:p,enableTextConditions:d}){let u={},I=l=>{let i=[];for(let r of l){let n=r.value;r.inputId&&(n=p.getInputById(r.inputId)?.value??null),i.push(n)}return i},g=(l,i=null)=>{let r=l.rule.text.trim();return!d||r.length==0?!0:(i??=f(),u[r]||(u[r]=new Function(...Object.keys(i),"return !!("+r+")").bind({})),u[r](...Object.values(i)))},f=()=>{let l={};for(let i of p.getInputs())l[i.name]=i.value,l[i.id]=i.value;return{inputs:l}},h=c.batch([{event:A.CLOSE,subscription:()=>{h()}},{event:A.CALC,subscription:{method:l=>{let i=l.detail.element;if(!i?.conditions?.actions||i.conditions.actions.length==0)return;let r=f();for(let n of i.conditions.actions){try{if(!g(n,r))continue}catch{continue}for(let o of n.changes){let y=p.getMethod(o.type);y&&y.resolve({layer:i,event:l},...I(o.arguments))}}},priority:-250}}]);return{canActionResolve:g,generateActionArguments:f,resolveArguments:I}}function k({herald:c,modules:p}){let d={},u={},I={},g=R({inputsMap:d,inputsTypeMap:u,methodsMap:I,modules:p}),f=()=>{try{return new Function("return 1"),!0}catch(i){return/unsafe-eval|CSP/.exec(i.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},h=S({inputsMap:d,herald:c,modules:p,inputsTypeMap:u,methodsMap:I,crud:g}),l=H({enableTextConditions:f(),inputsMap:d,herald:c,modules:p,crud:g});return{getInputsMap:()=>({...u}),getMethodsMap:()=>({...I}),...h,...g,...l}}export{k as Conditions,P as Event,M as actionLayerSymbol,E as changeActionSymbol,b as inputLayerSymbol};
