var M=Symbol("Input Layer"),A=Symbol("Action Layer"),x=Symbol("Change Action"),P=(d=>(d.REGISTER_INPUT="antetype.conditions.input.register",d.REGISTER_METHOD="antetype.conditions.method.register",d))(P||{});function R({inputsMap:l,inputsTypeMap:c,methodsMap:d,modules:u}){let I=e=>d[e]??null,m=(e,t)=>{let s=t[x]?.changes??[];for(let a=0;a<s.length;a++)if(s[a]===t){s.splice(a,1);break}for(let a=0;a<e.changes.length;a++)if(e.changes[a]===t){e.changes.splice(a,1);break}},h=(e,t)=>{let s={[x]:e,type:t.type,arguments:[...t.arguments??[]]};return e.changes.push(s),s},f=(e,t)=>{let s=t[A]?.conditions?.actions??[];for(let a=0;a<s.length;a++)if(s[a]===t){s.splice(a,1);break}for(let a=0;a<e.length;a++)if(e[a]===t){e.splice(a,1);break}},p=e=>{e.conditions??={},e.conditions.actions??=[];let t={[A]:e,rule:{text:""},changes:[]};return e.conditions.actions.push(t),t},i=(e,t)=>{t.id=u.core.meta.generateId(),t[M]=e,l[t.id]=t},o=(e,t)=>{let s=t.generate(e);return i(e,s),e.conditions??={},e.conditions.inputs??=[],e.conditions.inputs.push(s),s},n=e=>{let t=e[M]?.conditions?.inputs??[];for(let s=0;s<t.length;s++)if(t[s]===e){t.splice(s,1);break}e.id&&delete l[e.id]},r=e=>l[e]??null,y=e=>e[M]??null,b=()=>Object.values(l),E=e=>c[e]??null,v=e=>{let t=e.conditions?.inputs??[];for(let s=0;s<t.length;s++){let a=t[s];if(a[M])continue;let w=E(a.type);if(w){let H=w.generate(e);for(let T in a)H[T]=a[T];t[s]=a=H}a.id||(a.id=u.core.meta.generateId()),l[a.id]=a,a[M]=e}for(let s of e.layout??[])v(s)},g=e=>{for(let t of e.conditions?.actions??[])if(!t[A]){t[A]=e;for(let s of t.changes)s[x]=t}for(let t of e.layout??[])g(t)};return{addInput:o,removeInput:n,getInputByType:E,getInputById:r,getInputs:b,getInputLayer:y,addEmptyAction:p,removeAction:f,addChange:h,removeChange:m,getMethod:I,registerInput:i,registerNewInputs:v,registerNewActions:g}}var C={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var j="core",F="0.0.5",J=class{#e;#t=null;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(l){this.#e=l}async loadModules(l,c){return(await this.#o()).loadModules(l,c)}register(l){let{registration:c}=l.detail;c[j]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(d,u)=>this.#t({canvas:u,modules:d,herald:this.#e.herald})),version:F}}static subscriptions={[C.MODULES]:"register"};#r(l){return import(this.#e.marshal.getResourceUrl(this,l))}async#o(){return this.#n??=(await this.#r("helper.js")).default,new this.#n(this.#e.herald)}};function S({modules:l,herald:c,crud:d,inputsTypeMap:u,methodsMap:I}){let m=async()=>{let i={},o=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:i}});await c.dispatch(o);for(let n in u)delete u[n];for(let n in o.detail.inputs){let r=o.detail.inputs[n];u[r.type]=r}return o.detail.inputs},h=async()=>{let i={},o=new CustomEvent("antetype.conditions.method.register",{detail:{methods:i}});await c.dispatch(o);for(let n in I)delete I[n];for(let n in o.detail.methods){let r=o.detail.methods[n];I[r.type]=r}return o.detail.methods},f={},p=c.batch([{event:C.CLOSE,subscription:()=>{p()}},{event:C.INIT,subscription:{method:async i=>{await Promise.all([m(),h()]);let{base:o}=i.detail;for(let n of o)d.registerNewInputs(n),d.registerNewActions(n)},priority:-10}},{event:"antetype.conditions.input.register",subscription:i=>{let{inputs:o}=i.detail;o.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},o.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(n){if(n===null){for(let r of this.options)r.checked=!1;return}for(let r of this.options)n==r.value?r.checked=!0:r.checked=!1},get value(){for(let n of this.options)if(n.checked)return n.value;return null},options:[]})},o.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(n){if(n===null){for(let r of this.options)r.checked=!1;return}for(let r of this.options)n.indexOf(r.value)!==-1?r.checked=!0:r.checked=!1},get value(){let n=[];for(let r of this.options)r.checked&&n.push(r.value);return n},options:[]})},o.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}}},{event:"antetype.conditions.method.register",subscription:i=>{let{methods:o}=i.detail;o.hide={name:"Hide layer",type:"hide",resolve:({event:n})=>{n.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}}}},o.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:n},r)=>{if(!r||n.type!=="image")return;n.image.src=r;let y=l.core.clone.getOriginal(n);if(f[r]?.has(y))return;f[r]??=new WeakMap,f[r].set(y,!0);let b=new Image;b.onload=function(){l.core.view.recalculate().then(()=>{l.core.view.redraw()})},b.src=r}},o.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:n},r)=>{!r||n.type!=="text"||(n.text.value=r)}},o.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:n},r,y)=>{if(!r)return;let b=(v,g,e,t=0)=>{if(g.length==t+1){v[g[t]]=e;return}let s=typeof v[g[t]];if(s!="undefined"&&s!="object"&&v[g[t]]!==null){console.error("Cannot replace scalar value with object by template actions",v,g,e);return}v[g[t]]??={},b(v[g[t]],g,e,t+1)},E=r.split(".");b(n,E,y)}}}}]);return{retrieveInputs:m,retrieveMethods:h}}function D({herald:l,crud:c,enableTextConditions:d}){let u={},I=p=>{let i=[];for(let o of p){let n=o.value;o.inputId&&(n=c.getInputById(o.inputId)?.value??null),i.push(n)}return i},m=(p,i=null)=>{let o=p.rule.text.trim();return!d||o.length==0?!0:(i??=h(),u[o]||(u[o]=new Function(...Object.keys(i),"return !!("+o+")").bind({})),u[o](...Object.values(i)))},h=()=>{let p={};for(let i of c.getInputs())p[i.name]=i.value,p[i.id]=i.value;return{inputs:p}},f=l.batch([{event:C.CLOSE,subscription:()=>{f()}},{event:C.CALC,subscription:{method:p=>{let i=p.detail.element;if(!i?.conditions?.actions||i.conditions.actions.length==0)return;let o=h();for(let n of i.conditions.actions){try{if(!m(n,o))continue}catch{continue}for(let r of n.changes){let y=c.getMethod(r.type);y&&y.resolve({layer:i,event:p},...I(r.arguments))}}},priority:-250}}]);return{canActionResolve:m,generateActionArguments:h,resolveArguments:I}}function k({herald:l,modules:c}){let d={},u={},I={},m=R({inputsMap:d,inputsTypeMap:u,methodsMap:I,modules:c}),h=()=>{try{return new Function("return 1"),!0}catch(i){return/unsafe-eval|CSP/.exec(i.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},f=S({inputsMap:d,herald:l,modules:c,inputsTypeMap:u,methodsMap:I,crud:m}),p=D({enableTextConditions:h(),inputsMap:d,herald:l,modules:c,crud:m});return{getInputsMap:()=>({...u}),getMethodsMap:()=>({...I}),...f,...m,...p}}var N="conditions",L="0.0.4",O=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(c){this.#e=c}register(c){let{registration:d}=c.detail;d[N]={load:async()=>{if(!this.#t){let u=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(u)).default}return(u,I)=>this.#t({canvas:I,modules:u,herald:this.#e.herald})},version:L}}static subscriptions={[C.MODULES]:"register"}};export{k as Conditions,P as Event,N as ID,L as VERSION,A as actionLayerSymbol,x as changeActionSymbol,M as inputLayerSymbol};
