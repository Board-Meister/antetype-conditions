var x=Symbol("Input Layer"),A=Symbol("Action Layer"),E=Symbol("Change Action"),T=(p=>(p.REGISTER_INPUT="antetype.conditions.input.register",p.REGISTER_METHOD="antetype.conditions.method.register",p))(T||{});function R({inputsMap:s,inputsTypeMap:u,methodsMap:p,modules:c}){let g=r=>p[r]??null,h=(r,i)=>{let a=i[E]?.changes??[];for(let l=0;l<a.length;l++)if(a[l]===i){a.splice(l,1);break}for(let l=0;l<r.changes.length;l++)if(r.changes[l]===i){r.changes.splice(l,1);break}},y=(r,i)=>{let a={[E]:r,type:i.type,arguments:[...i.arguments??[]]};return r.changes.push(a),a},v=(r,i)=>{let a=i[A]?.conditions?.actions??[];for(let l=0;l<a.length;l++)if(a[l]===i){a.splice(l,1);break}for(let l=0;l<r.length;l++)if(r[l]===i){r.splice(l,1);break}},m=r=>{r.conditions??={},r.conditions.actions??=[];let i={[A]:r,rule:{text:""},changes:[]};return r.conditions.actions.push(i),i},o=(r,i)=>{i.id=c.core.meta.generateId(),i[x]=r,s[i.id]=i},t=(r,i)=>{let a=i.generate(r);return o(r,a),r.conditions??={},r.conditions.inputs??=[],r.conditions.inputs.push(a),a},e=r=>{let i=r[x]?.conditions?.inputs??[];for(let a=0;a<i.length;a++)if(i[a]===r){i.splice(a,1);break}r.id&&delete s[r.id]},n=r=>s[r]??null,d=r=>r[x]??null,I=()=>Object.values(s),w=r=>u[r]??null,f=r=>{let i=r.conditions?.inputs??[];for(let a=0;a<i.length;a++){let l=i[a];if(l[x])continue;let M=w(l.type);if(M){let D=M.generate(r);for(let P in l)D[P]=l[P];i[a]=l=D}l.id||(l.id=c.core.meta.generateId()),s[l.id]=l,l[x]=r}for(let a of r.layout??[])f(a)},b=r=>{for(let i of r.conditions?.actions??[])if(!i[A]){i[A]=r;for(let a of i.changes)a[E]=i}for(let i of r.layout??[])b(i)};return{addInput:t,removeInput:e,getInputByType:w,getInputById:n,getInputs:I,getInputLayer:d,addEmptyAction:m,removeAction:v,addChange:y,removeChange:h,getMethod:g,registerInput:o,registerNewInputs:f,registerNewActions:b}}var C={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var B="core",F="0.0.5",K=class{#e;#t=null;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(s){this.#e=s}async loadModules(s,u){return(await this.#o()).loadModules(s,u)}register(s){let{registration:u}=s.detail;u[B]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(p,c)=>this.#t({canvas:c,modules:p,herald:this.#e.herald})),version:F}}static subscriptions={[C.MODULES]:"register"};#r(s){return import(this.#e.marshal.getResourceUrl(this,s))}async#o(){return this.#n??=(await this.#r("helper.js")).default,new this.#n(this.#e.herald)}};function S({modules:s,herald:u,crud:p,inputsTypeMap:c,methodsMap:g}){let h=async()=>{let o={},t=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:o}});await u.dispatch(t);for(let e in c)delete c[e];for(let e in t.detail.inputs){let n=t.detail.inputs[e];c[n.type]=n}return t.detail.inputs},y=async()=>{let o={},t=new CustomEvent("antetype.conditions.method.register",{detail:{methods:o}});await u.dispatch(t);for(let e in g)delete g[e];for(let e in t.detail.methods){let n=t.detail.methods[e];g[n.type]=n}return t.detail.methods},v={},m=u.batch([{event:C.CLOSE,subscription:()=>{m()}},{event:C.INIT,subscription:{method:async o=>{await Promise.all([h(),y()]);let{base:t}=o.detail;for(let e of t)p.registerNewInputs(e),p.registerNewActions(e)},priority:-10}},{event:"antetype.conditions.input.register",subscription:o=>{let{inputs:t}=o.detail;t.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},t.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(e){if(e===null){for(let n of this.options)n.checked=!1;return}for(let n of this.options)e==n.value?n.checked=!0:n.checked=!1},get value(){for(let e of this.options)if(e.checked)return e.value;return null},options:[]})},t.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(e){if(e===null){for(let n of this.options)n.checked=!1;return}for(let n of this.options)e.indexOf(n.value)!==-1?n.checked=!0:n.checked=!1},get value(){let e=[];for(let n of this.options)n.checked&&e.push(n.value);return e},options:[]})},t.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}}},{event:"antetype.conditions.method.register",subscription:o=>{let{methods:t}=o.detail;t.hide={name:"Hide layer",type:"hide",resolve:({event:e})=>{e.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}}}},t.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:e},n)=>{if(!n||e.type!=="image")return;e.image.src=n;let d=s.core.clone.getOriginal(e);if(v[n]?.has(d))return;v[n]??=new WeakMap,v[n].set(d,!0);let I=new Image;I.onload=function(){s.core.view.recalculate().then(()=>{s.core.view.redraw()})},I.src=n}},t.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:e},n)=>{!n||e.type!=="text"||(e.text.value=n)}},t.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:e},n,d)=>{if(!n)return;let I=(f,b,r,i=0)=>{if(b.length==i+1){f[b[i]]=r;return}let a=typeof f[b[i]];if(a!="undefined"&&a!="object"&&f[b[i]]!==null){console.error("Cannot replace scalar value with object by template actions",f,b,r);return}f[b[i]]??={},I(f[b[i]],b,r,i+1)},w=n.split(".");I(e,w,d)}}}}]);return{retrieveInputs:h,retrieveMethods:y}}function k({herald:s,crud:u,enableTextConditions:p}){let c={},g=m=>{let o=[];for(let t of m){let e=t.value;t.inputId&&(e=u.getInputById(t.inputId)?.value??null),o.push(e)}return o},h=(m,o=null)=>{let t=m.rule.text.trim();return!p||t.length==0?!0:(o??=y(),c[t]||(c[t]=new Function(...Object.keys(o),"return !!("+t+")").bind({})),c[t](...Object.values(o)))},y=()=>{let m={};for(let o of u.getInputs())m[o.name]=o.value,m[o.id]=o.value;return{inputs:m}},v=s.batch([{event:C.CLOSE,subscription:()=>{v()}},{event:C.CALC,subscription:{method:m=>{let o=m.detail.element;if(!o?.conditions?.actions||o.conditions.actions.length==0)return;let t=y();for(let e of o.conditions.actions){try{if(!h(e,t))continue}catch{continue}for(let n of e.changes){let d=u.getMethod(n.type);d&&d.resolve({layer:o,event:m},...g(n.arguments))}}},priority:-250}}]);return{canActionResolve:h,generateActionArguments:y,resolveArguments:g}}function H({modules:s}){let u=null,p=1.2*10**5,c=o=>{if(!u){u={};for(let t of s.conditions.getInputs())u[t.name]=t}return u[o]??null},g=(o,t)=>{let e={...t};for(let n of s.conditions.getInputs())n.id in t||n.name in t||(e[n.id]=JSON.stringify(o[n.id]));return e},h=(o,t,e)=>{let n=setTimeout(()=>{o(null)},p),d=g(e,t.values);for(let I in d){if(!Object.hasOwn(d,I))continue;let w=d[I],f=s.conditions.getInputById(I)??c(I);if(f){try{f.value=JSON.parse(w)}catch{f.value=w}s.core.clone.getClone(f).value=f.value}}s.workspace.export(t.settings).then(I=>{o(URL.createObjectURL(I)),clearTimeout(n)})},y=(o,t)=>{let e=[],n=new Promise(d=>{d(null)});for(let d of t)n=new Promise(I=>{n.then(()=>{h(I,d,o)})}),e.push(n);return e},v=async o=>{for(let t in o){if(!Object.hasOwn(o,t))continue;let e=s.conditions.getInputById(t);e&&(e.value=s.core.clone.getClone(e).value=o[t])}await s.core.view.recalculate(),s.core.view.redraw()};return{bulkGenerate:o=>{let t=s.conditions.getInputs().reduce((I,w)=>(I[w.id]=w.value,I),{}),e=s.core.setting,n=e.get("illustrator.image.waitForLoad");e.set("illustrator.image.waitForLoad",!0);let d=y(t,o);return Promise.all(d).then(()=>{e.set("illustrator.image.waitForLoad",n),v(t)}),d}}}function O({herald:s,modules:u}){let p={},c={},g={},h=R({inputsMap:p,inputsTypeMap:c,methodsMap:g,modules:u}),y=H({modules:u,herald:s}),v=()=>{try{return new Function("return 1"),!0}catch(t){return/unsafe-eval|CSP/.exec(t.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},m=S({inputsMap:p,herald:s,modules:u,inputsTypeMap:c,methodsMap:g,crud:h}),o=k({enableTextConditions:v(),inputsMap:p,herald:s,modules:u,crud:h});return{getInputsMap:()=>({...c}),getMethodsMap:()=>({...g}),...m,...h,...o,...y}}var N="conditions",j="0.0.4",L=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(u){this.#e=u}register(u){let{registration:p}=u.detail;p[N]={load:async()=>{if(!this.#t){let c=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(c)).default}return(c,g)=>this.#t({canvas:g,modules:c,herald:this.#e.herald})},version:j}}static subscriptions={[C.MODULES]:"register"}};export{O as Conditions,T as Event,N as ID,j as VERSION,A as actionLayerSymbol,E as changeActionSymbol,x as inputLayerSymbol};
