var E=Symbol("Input Layer"),x=Symbol("Action Layer"),M=Symbol("Change Action"),D=(g=>(g.REGISTER_INPUT="antetype.conditions.input.register",g.REGISTER_METHOD="antetype.conditions.method.register",g))(D||{});function k({inputsMap:n,inputsTypeMap:m,methodsMap:g,modules:f}){let y=e=>g[e]??null,v=(e,t)=>{let i=t[M]?.changes??[];for(let a=0;a<i.length;a++)if(i[a]===t){i.splice(a,1);break}for(let a=0;a<e.changes.length;a++)if(e.changes[a]===t){e.changes.splice(a,1);break}},h=(e,t)=>{let i={[M]:e,type:t.type,arguments:[...t.arguments??[]]};return e.changes.push(i),i},d=(e,t)=>{let i=t[x]?.conditions?.actions??[];for(let a=0;a<i.length;a++)if(i[a]===t){i.splice(a,1);break}for(let a=0;a<e.length;a++)if(e[a]===t){e.splice(a,1);break}},I=e=>{e.conditions??={},e.conditions.actions??=[];let t={[x]:e,rule:{text:""},changes:[]};return e.conditions.actions.push(t),t},p=(e,t)=>{t.id=f.core.meta.generateId(),t[E]=e,n[t.id]=t},o=(e,t)=>{let i=t.generate(e);return p(e,i),e.conditions??={},e.conditions.inputs??=[],e.conditions.inputs.push(i),i},l=e=>{let t=e[E]?.conditions?.inputs??[];for(let i=0;i<t.length;i++)if(t[i]===e){t.splice(i,1);break}e.id&&delete n[e.id]},u=e=>n[e]??null,c=e=>e[E]??null,r=()=>Object.values(n),s=e=>m[e]??null,w=e=>{let t=e.conditions?.inputs??[];for(let i=0;i<t.length;i++){let a=t[i];if(a[E]){n[a.id]=a;continue}let C=s(a.type);if(C){let R=C.generate(e);for(let T in a)R[T]=a[T];t[i]=a=R}a.id??=f.core.meta.generateId(),n[a.id]??=a,a[E]??=f.core.clone.getOriginal(e)}for(let i of e.layout??[])w(i)},b=e=>{for(let t of e.conditions?.actions??[])if(!t[x]){t[x]=e;for(let i of t.changes)i[M]=t}for(let t of e.layout??[])b(t)};return{addInput:o,removeInput:l,getInputByType:s,getInputById:u,getInputs:r,getInputLayer:c,addEmptyAction:I,removeAction:d,addChange:h,removeChange:v,getMethod:y,registerInput:p,registerNewInputs:w,registerNewActions:b}}var A={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"},J=Symbol("original"),Y=Symbol("clone");var q=Symbol("layer");var N="core",O="0.0.5",K=class{#t;#n=null;#e=!1;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(n){this.#t=n}async loadModules(n){return(await this.#i()).loadModules(n)}register(n){let{registration:m}=n.detail;m[N]={load:async()=>(!this.#n&&!this.#e&&(this.#e=new Promise(g=>{this.#o("core.js").then(f=>{this.#n=f.default,this.#e=!1,g()})})),this.#e&&await this.#e,console.log("load module3",this.#n),g=>this.#n({modules:g,herald:this.#t.herald})),version:O}}static subscriptions={[A.MODULES]:"register"};#o(n){return import(this.#t.marshal.getResourceUrl(this,n))}async#i(){return this.#r??=(await this.#o("helper.js")).default,new this.#r(this.#t.herald)}};function S({modules:n,herald:m,crud:g,inputsTypeMap:f,methodsMap:y,additional:v}){let h=async()=>{let o={},l=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:o}});await m.dispatch(l,{origin:n.core.meta.getCanvas()});for(let u in f)delete f[u];for(let u in l.detail.inputs){let c=l.detail.inputs[u];f[c.type]=c}return l.detail.inputs},d=async()=>{let o={},l=new CustomEvent("antetype.conditions.method.register",{detail:{methods:o}});await m.dispatch(l,{origin:n.core.meta.getCanvas()});for(let u in y)delete y[u];for(let u in l.detail.methods){let c=l.detail.methods[u];y[c.type]=c}return l.detail.methods},I={},p=(o=null)=>{o??=n.core.meta.getCanvas();let l=m.batch([{event:A.CLOSE,subscription:()=>{l()},anchor:o},{event:A.CANVAS_CHANGE,subscription:({detail:{current:u}})=>{l(),p(u)},anchor:o},{event:A.INIT,subscription:{method:async u=>{await Promise.all([h(),d()]);let{base:c}=u.detail;for(let r of c)g.registerNewInputs(r),g.registerNewActions(r)},priority:-10,anchor:o}},{event:"antetype.conditions.input.register",subscription:u=>{let{inputs:c}=u.detail;c.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},c.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(r){if(r===null){for(let s of this.options)s.checked=!1;return}for(let s of this.options)r==s.value?s.checked=!0:s.checked=!1},get value(){for(let r of this.options)if(r.checked)return r.value;return null},options:[]})},c.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(r){if(r===null){for(let s of this.options)s.checked=!1;return}for(let s of this.options)r.indexOf(s.value)!==-1?s.checked=!0:s.checked=!1},get value(){let r=[];for(let s of this.options)s.checked&&r.push(s.value);return r},options:[]})},c.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}},anchor:o},{event:"antetype.conditions.method.register",subscription:u=>{let{methods:c}=u.detail;c.hide={name:"Hide layer",type:"hide",resolve:({event:r})=>{r.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}}}},c.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:r},s)=>{if(!s||r.type!=="image")return;r.image.src=s;let w=n.core.clone.getOriginal(r);if(I[s]?.has(w))return;I[s]??=new WeakMap,I[s].set(w,!0);let b=new Image;b.onload=function(){n.core.view.recalculate().then(()=>{n.core.view.redraw()})},b.src=s}},c.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:r},s)=>{!s||r.type!=="text"||(r.text.value=s)}},c.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:r},s,w)=>{if(!s)return;let b=(t,i,a,C=0)=>{if(i.length==C+1){t[i[C]]=a;return}let R=typeof t[i[C]];if(R!="undefined"&&R!="object"&&t[i[C]]!==null){console.error("Cannot replace scalar value with object by template actions",t,i,a);return}t[i[C]]??={},b(t[i[C]],i,a,C+1)},e=s.split(".");b(r,e,w)}}},anchor:o},...v.reduce((u,c)=>[...u,...c(o)],[])])};return p(),{retrieveInputs:h,retrieveMethods:d}}function H({crud:n,enableTextConditions:m}){let g={},f=h=>{let d=[];for(let I of h){let p=I.value;I.inputId&&(p=n.getInputById(I.inputId)?.value??null),d.push(p)}return d},y=(h,d=null)=>{let I=h.rule.text.trim();return!m||I.length==0?!0:(d??=v(),g[I]||(g[I]=new Function(...Object.keys(d),"return !!("+I+")").bind({})),g[I](...Object.values(d)))},v=()=>{let h={};for(let d of n.getInputs())h[d.name]=d.value,h[d.id]=d.value;return{inputs:h}};return{props:{canActionResolve:y,generateActionArguments:v,resolveArguments:f},events:(h=null)=>[{event:A.CALC,subscription:{method:d=>{let I=d.detail.element;if(!I?.conditions?.actions||I.conditions.actions.length==0)return;let p=v();for(let o of I.conditions.actions){try{if(!y(o,p))continue}catch{continue}for(let l of o.changes){let u=n.getMethod(l.type);u&&u.resolve({layer:I,event:d},...f(l.arguments))}}},priority:-250,anchor:h}}]}}function P({modules:n}){let m=null,g=1.2*10**5,f=p=>{if(!m){m={};for(let o of n.conditions.getInputs())m[o.name]=o}return m[p]??null},y=(p,o)=>{let l={...o};for(let u of n.conditions.getInputs())u.id in o||u.name in o||(l[u.id]=JSON.stringify(p[u.id]));return l},v=(p,o,l)=>{let u=setTimeout(()=>{p(null)},g),c=y(l,o.values);for(let r in c){if(!Object.hasOwn(c,r))continue;let s=c[r],w=n.conditions.getInputById(r)??f(r);if(w){try{w.value=JSON.parse(s)}catch{w.value=s}n.core.clone.getClone(w).value=w.value}}n.workspace.export(o.settings).then(r=>{p(URL.createObjectURL(r)),clearTimeout(u)})},h=(p,o)=>{let l=[],u=new Promise(c=>{c(null)});for(let c of o)u=new Promise(r=>{u.then(()=>{v(r,c,p)})}),l.push(u);return l},d=async p=>{for(let o in p){if(!Object.hasOwn(p,o))continue;let l=n.conditions.getInputById(o);l&&(l.value=n.core.clone.getClone(l).value=p[o])}await n.core.view.recalculate(),n.core.view.redraw()};return{bulkGenerate:p=>{let o=n.conditions.getInputs().reduce((r,s)=>(r[s.id]=s.value,r),{}),l=n.core.setting,u=l.get("illustrator.image.waitForLoad");l.set("illustrator.image.waitForLoad",!0);let c=h(o,p);return Promise.all(c).then(()=>{l.set("illustrator.image.waitForLoad",u),d(o)}),c}}}function L({herald:n,modules:m}){let g={},f={},y={},v=k({inputsMap:g,inputsTypeMap:f,methodsMap:y,modules:m}),h=P({modules:m,herald:n}),d=()=>{try{return new Function("return 1"),!0}catch(l){return/unsafe-eval|CSP/.exec(l.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},{props:I,events:p}=H({enableTextConditions:d(),inputsMap:g,herald:n,modules:m,crud:v}),o=S({inputsMap:g,herald:n,modules:m,inputsTypeMap:f,methodsMap:y,crud:v,additional:[p]});return console.log(v),{getInputsMap:()=>({...f}),getMethodsMap:()=>({...y}),...o,...v,...I,...h}}export{D as Event,x as actionLayerSymbol,M as changeActionSymbol,L as default,E as inputLayerSymbol};
