var A=Symbol("Input Layer"),M=Symbol("Action Layer"),x=Symbol("Change Action"),P=(p=>(p.REGISTER_INPUT="antetype.conditions.input.register",p.REGISTER_METHOD="antetype.conditions.method.register",p))(P||{});function R({inputsMap:l,inputsTypeMap:c,methodsMap:p,modules:u}){let I=e=>p[e]??null,g=(e,t)=>{let s=t[x]?.changes??[];for(let a=0;a<s.length;a++)if(s[a]===t){s.splice(a,1);break}for(let a=0;a<e.changes.length;a++)if(e.changes[a]===t){e.changes.splice(a,1);break}},h=(e,t)=>{let s={[x]:e,type:t.type,arguments:[...t.arguments??[]]};return e.changes.push(s),s},f=(e,t)=>{let s=t[M]?.conditions?.actions??[];for(let a=0;a<s.length;a++)if(s[a]===t){s.splice(a,1);break}for(let a=0;a<e.length;a++)if(e[a]===t){e.splice(a,1);break}},d=e=>{e.conditions??={},e.conditions.actions??=[];let t={[M]:e,rule:{text:""},changes:[]};return e.conditions.actions.push(t),t},i=(e,t)=>{t.id=u.core.meta.generateId(),t[A]=e,l[t.id]=t},o=(e,t)=>{let s=t.generate(e);return i(e,s),e.conditions??={},e.conditions.inputs??=[],e.conditions.inputs.push(s),s},n=e=>{let t=e[A]?.conditions?.inputs??[];for(let s=0;s<t.length;s++)if(t[s]===e){t.splice(s,1);break}e.id&&delete l[e.id]},r=e=>l[e]??null,y=e=>e[A]??null,C=()=>Object.values(l),E=e=>c[e]??null,v=e=>{let t=e.conditions?.inputs??[];for(let s=0;s<t.length;s++){let a=t[s];if(a[A])continue;let b=E(a.type);if(b){let H=b.generate(e);for(let T in a)H[T]=a[T];t[s]=a=H}a.id||(a.id=u.core.meta.generateId()),l[a.id]=a,a[A]=e}for(let s of e.layout??[])v(s)},m=e=>{for(let t of e.conditions?.actions??[])if(!t[M]){t[M]=e;for(let s of t.changes)s[x]=t}for(let t of e.layout??[])m(t)};return{addInput:o,removeInput:n,getInputByType:E,getInputById:r,getInputs:C,getInputLayer:y,addEmptyAction:d,removeAction:f,addChange:h,removeChange:g,getMethod:I,registerInput:i,registerNewInputs:v,registerNewActions:m}}var w={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var k="core",N="0.0.5",V=class{#e;#t=null;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(l){this.#e=l}async loadModules(l,c){return(await this.#o()).loadModules(l,c)}register(l){let{registration:c}=l.detail;c[k]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(p,u)=>this.#t({canvas:u,modules:p,herald:this.#e.herald})),version:N}}static subscriptions={[w.MODULES]:"register"};#r(l){return import(this.#e.marshal.getResourceUrl(this,l))}async#o(){return this.#n??=(await this.#r("helper.js")).default,new this.#n(this.#e.herald)}};function S({modules:l,herald:c,crud:p,inputsTypeMap:u,methodsMap:I}){let g=async()=>{let i={},o=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:i}});await c.dispatch(o);for(let n in u)delete u[n];for(let n in o.detail.inputs){let r=o.detail.inputs[n];u[r.type]=r}return o.detail.inputs},h=async()=>{let i={},o=new CustomEvent("antetype.conditions.method.register",{detail:{methods:i}});await c.dispatch(o);for(let n in I)delete I[n];for(let n in o.detail.methods){let r=o.detail.methods[n];I[r.type]=r}return o.detail.methods},f={},d=c.batch([{event:w.CLOSE,subscription:()=>{d()}},{event:w.INIT,subscription:{method:async i=>{await Promise.all([g(),h()]);let{base:o}=i.detail;for(let n of o)p.registerNewInputs(n),p.registerNewActions(n)},priority:-10}},{event:"antetype.conditions.input.register",subscription:i=>{let{inputs:o}=i.detail;o.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},o.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(n){if(n===null){for(let r of this.options)r.checked=!1;return}for(let r of this.options)n==r.value?r.checked=!0:r.checked=!1},get value(){for(let n of this.options)if(n.checked)return n.value;return null},options:[]})},o.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(n){if(n===null){for(let r of this.options)r.checked=!1;return}for(let r of this.options)n.indexOf(r.value)!==-1?r.checked=!0:r.checked=!1},get value(){let n=[];for(let r of this.options)r.checked&&n.push(r.value);return n},options:[]})},o.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}}},{event:"antetype.conditions.method.register",subscription:i=>{let{methods:o}=i.detail;o.hide={name:"Hide layer",type:"hide",resolve:({event:n})=>{n.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}}}},o.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:n},r)=>{if(!r||n.type!=="image")return;n.image.src=r;let y=l.core.clone.getOriginal(n);if(f[r]?.has(y))return;f[r]??=new WeakMap,f[r].set(y,!0);let C=new Image;C.onload=function(){l.core.view.recalculate().then(()=>{l.core.view.redraw()})},C.src=r}},o.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:n},r)=>{!r||n.type!=="text"||(n.text.value=r)}},o.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:n},r,y)=>{if(!r)return;let C=(v,m,e,t=0)=>{if(m.length==t+1){v[m[t]]=e;return}let s=typeof v[m[t]];if(s!="undefined"&&s!="object"&&v[m[t]]!==null){console.error("Cannot replace scalar value with object by template actions",v,m,e);return}v[m[t]]??={},C(v[m[t]],m,e,t+1)},E=r.split(".");C(n,E,y)}}}}]);return{retrieveInputs:g,retrieveMethods:h}}function D({herald:l,crud:c,enableTextConditions:p}){let u={},I=d=>{let i=[];for(let o of d){let n=o.value;o.inputId&&(n=c.getInputById(o.inputId)?.value??null),i.push(n)}return i},g=(d,i=null)=>{let o=d.rule.text.trim();return!p||o.length==0?!0:(i??=h(),u[o]||(u[o]=new Function(...Object.keys(i),"return !!("+o+")").bind({})),u[o](...Object.values(i)))},h=()=>{let d={};for(let i of c.getInputs())d[i.name]=i.value,d[i.id]=i.value;return{inputs:d}},f=l.batch([{event:w.CLOSE,subscription:()=>{f()}},{event:w.CALC,subscription:{method:d=>{let i=d.detail.element;if(!i?.conditions?.actions||i.conditions.actions.length==0)return;let o=h();for(let n of i.conditions.actions){try{if(!g(n,o))continue}catch{continue}for(let r of n.changes){let y=c.getMethod(r.type);y&&y.resolve({layer:i,event:d},...I(r.arguments))}}},priority:-250}}]);return{canActionResolve:g,generateActionArguments:h,resolveArguments:I}}function O({herald:l,modules:c}){let p={},u={},I={},g=R({inputsMap:p,inputsTypeMap:u,methodsMap:I,modules:c}),h=()=>{try{return new Function("return 1"),!0}catch(i){return/unsafe-eval|CSP/.exec(i.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},f=S({inputsMap:p,herald:l,modules:c,inputsTypeMap:u,methodsMap:I,crud:g}),d=D({enableTextConditions:h(),inputsMap:p,herald:l,modules:c,crud:g});return{getInputsMap:()=>({...u}),getMethodsMap:()=>({...I}),...f,...g,...d}}export{P as Event,M as actionLayerSymbol,x as changeActionSymbol,O as default,A as inputLayerSymbol};
