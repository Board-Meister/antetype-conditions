var M=Symbol("Input Layer"),x=Symbol("Action Layer"),E=Symbol("Change Action"),T=(I=>(I.REGISTER_INPUT="antetype.conditions.input.register",I.REGISTER_METHOD="antetype.conditions.method.register",I))(T||{});function R({inputsMap:s,inputsTypeMap:u,methodsMap:I,modules:d}){let f=r=>I[r]??null,h=(r,i)=>{let a=i[E]?.changes??[];for(let l=0;l<a.length;l++)if(a[l]===i){a.splice(l,1);break}for(let l=0;l<r.changes.length;l++)if(r.changes[l]===i){r.changes.splice(l,1);break}},y=(r,i)=>{let a={[E]:r,type:i.type,arguments:[...i.arguments??[]]};return r.changes.push(a),a},v=(r,i)=>{let a=i[x]?.conditions?.actions??[];for(let l=0;l<a.length;l++)if(a[l]===i){a.splice(l,1);break}for(let l=0;l<r.length;l++)if(r[l]===i){r.splice(l,1);break}},m=r=>{r.conditions??={},r.conditions.actions??=[];let i={[x]:r,rule:{text:""},changes:[]};return r.conditions.actions.push(i),i},o=(r,i)=>{i.id=d.core.meta.generateId(),i[M]=r,s[i.id]=i},t=(r,i)=>{let a=i.generate(r);return o(r,a),r.conditions??={},r.conditions.inputs??=[],r.conditions.inputs.push(a),a},e=r=>{let i=r[M]?.conditions?.inputs??[];for(let a=0;a<i.length;a++)if(i[a]===r){i.splice(a,1);break}r.id&&delete s[r.id]},n=r=>s[r]??null,c=r=>r[M]??null,p=()=>Object.values(s),b=r=>u[r]??null,g=r=>{let i=r.conditions?.inputs??[];for(let a=0;a<i.length;a++){let l=i[a];if(l[M])continue;let A=b(l.type);if(A){let P=A.generate(r);for(let D in l)P[D]=l[D];i[a]=l=P}l.id||(l.id=d.core.meta.generateId()),s[l.id]=l,l[M]=r}for(let a of r.layout??[])g(a)},w=r=>{for(let i of r.conditions?.actions??[])if(!i[x]){i[x]=r;for(let a of i.changes)a[E]=i}for(let i of r.layout??[])w(i)};return{addInput:t,removeInput:e,getInputByType:b,getInputById:n,getInputs:p,getInputLayer:c,addEmptyAction:m,removeAction:v,addChange:y,removeChange:h,getMethod:f,registerInput:o,registerNewInputs:g,registerNewActions:w}}var C={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var O="core",L="0.0.5",J=class{#e;#t=null;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(s){this.#e=s}async loadModules(s,u){return(await this.#o()).loadModules(s,u)}register(s){let{registration:u}=s.detail;u[O]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(I,d)=>this.#t({canvas:d,modules:I,herald:this.#e.herald})),version:L}}static subscriptions={[C.MODULES]:"register"};#r(s){return import(this.#e.marshal.getResourceUrl(this,s))}async#o(){return this.#n??=(await this.#r("helper.js")).default,new this.#n(this.#e.herald)}};function k({modules:s,herald:u,crud:I,inputsTypeMap:d,methodsMap:f}){let h=async()=>{let o={},t=new CustomEvent("antetype.conditions.input.register",{detail:{inputs:o}});await u.dispatch(t);for(let e in d)delete d[e];for(let e in t.detail.inputs){let n=t.detail.inputs[e];d[n.type]=n}return t.detail.inputs},y=async()=>{let o={},t=new CustomEvent("antetype.conditions.method.register",{detail:{methods:o}});await u.dispatch(t);for(let e in f)delete f[e];for(let e in t.detail.methods){let n=t.detail.methods[e];f[n.type]=n}return t.detail.methods},v={},m=u.batch([{event:C.CLOSE,subscription:()=>{m()}},{event:C.INIT,subscription:{method:async o=>{await Promise.all([h(),y()]);let{base:t}=o.detail;for(let e of t)I.registerNewInputs(e),I.registerNewActions(e)},priority:-10}},{event:"antetype.conditions.input.register",subscription:o=>{let{inputs:t}=o.detail;t.text={type:"title",name:"Title",generate:()=>({type:"title",name:"Title Name",value:null})},t.select={type:"select",name:"Drop down",generate:()=>({_value:null,type:"select",name:"Drop down Name",set value(e){if(e===null){for(let n of this.options)n.checked=!1;return}for(let n of this.options)e==n.value?n.checked=!0:n.checked=!1},get value(){for(let e of this.options)if(e.checked)return e.value;return null},options:[]})},t.multiselect={type:"multiselect",name:"Multiselect",generate:()=>({type:"multiselect",name:"Multiselect Name",set value(e){if(e===null){for(let n of this.options)n.checked=!1;return}for(let n of this.options)e.indexOf(n.value)!==-1?n.checked=!0:n.checked=!1},get value(){let e=[];for(let n of this.options)n.checked&&e.push(n.value);return e},options:[]})},t.image={type:"image",name:"Image",generate:()=>({type:"image",name:"Image input Name",value:null})}}},{event:"antetype.conditions.method.register",subscription:o=>{let{methods:t}=o.detail;t.hide={name:"Hide layer",type:"hide",resolve:({event:e})=>{e.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}}}},t.setImage={name:"Set image",type:"set-image",arguments:[{name:"image",type:"image"}],resolve:({layer:e},n)=>{if(!n||e.type!=="image")return;e.image.src=n;let c=s.core.clone.getOriginal(e);if(v[n]?.has(c))return;v[n]??=new WeakMap,v[n].set(c,!0);let p=new Image;p.onload=function(){s.core.view.recalculate().then(()=>{s.core.view.redraw()})},p.src=n}},t.setText={name:"Set text",type:"set-text",arguments:[{name:"text",type:"text",placeholder:"New text"}],resolve:({layer:e},n)=>{!n||e.type!=="text"||(e.text.value=n)}},t.setProperty={name:"Set property",type:"set-property",arguments:[{name:"path",type:"text",placeholder:"Path to property (path.to.property)"},{name:"value",type:"text",placeholder:"New value"}],resolve:({layer:e},n,c)=>{if(!n)return;let p=(g,w,r,i=0)=>{if(w.length==i+1){g[w[i]]=r;return}let a=typeof g[w[i]];if(a!="undefined"&&a!="object"&&g[w[i]]!==null){console.error("Cannot replace scalar value with object by template actions",g,w,r);return}g[w[i]]??={},p(g[w[i]],w,r,i+1)},b=n.split(".");p(e,b,c)}}}}]);return{retrieveInputs:h,retrieveMethods:y}}function S({herald:s,crud:u,enableTextConditions:I}){let d={},f=m=>{let o=[];for(let t of m){let e=t.value;t.inputId&&(e=u.getInputById(t.inputId)?.value??null),o.push(e)}return o},h=(m,o=null)=>{let t=m.rule.text.trim();return!I||t.length==0?!0:(o??=y(),d[t]||(d[t]=new Function(...Object.keys(o),"return !!("+t+")").bind({})),d[t](...Object.values(o)))},y=()=>{let m={};for(let o of u.getInputs())m[o.name]=o.value,m[o.id]=o.value;return{inputs:m}},v=s.batch([{event:C.CLOSE,subscription:()=>{v()}},{event:C.CALC,subscription:{method:m=>{let o=m.detail.element;if(!o?.conditions?.actions||o.conditions.actions.length==0)return;let t=y();for(let e of o.conditions.actions){try{if(!h(e,t))continue}catch{continue}for(let n of e.changes){let c=u.getMethod(n.type);c&&c.resolve({layer:o,event:m},...f(n.arguments))}}},priority:-250}}]);return{canActionResolve:h,generateActionArguments:y,resolveArguments:f}}function H({modules:s}){let u=null,I=1.2*10**5,d=o=>{if(!u){u={};for(let t of s.conditions.getInputs())u[t.name]=t}return u[o]??null},f=(o,t)=>{let e={...t};for(let n of s.conditions.getInputs())n.id in t||n.name in t||(e[n.id]=JSON.stringify(o[n.id]));return e},h=(o,t,e)=>{let n=setTimeout(()=>{o(null)},I),c=f(e,t.values);for(let p in c){if(!Object.hasOwn(c,p))continue;let b=c[p],g=s.conditions.getInputById(p)??d(p);if(g){try{g.value=JSON.parse(b)}catch{g.value=b}s.core.clone.getClone(g).value=g.value}}s.workspace.export(t.settings).then(p=>{o(URL.createObjectURL(p)),clearTimeout(n)})},y=(o,t)=>{let e=[],n=new Promise(c=>{c(null)});for(let c of t)n=new Promise(p=>{n.then(()=>{h(p,c,o)})}),e.push(n);return e},v=async o=>{for(let t in o){if(!Object.hasOwn(o,t))continue;let e=s.conditions.getInputById(t);e&&(e.value=s.core.clone.getClone(e).value=o[t])}await s.core.view.recalculate(),s.core.view.redraw()};return{bulkGenerate:o=>{let t=s.conditions.getInputs().reduce((p,b)=>(p[b.id]=b.value,p),{}),e=s.core.setting,n=e.get("illustrator.image.waitForLoad");e.set("illustrator.image.waitForLoad",!0);let c=y(t,o);return Promise.all(c).then(()=>{e.set("illustrator.image.waitForLoad",n),v(t)}),c}}}function N({herald:s,modules:u}){let I={},d={},f={},h=R({inputsMap:I,inputsTypeMap:d,methodsMap:f,modules:u}),y=H({modules:u,herald:s}),v=()=>{try{return new Function("return 1"),!0}catch(t){return/unsafe-eval|CSP/.exec(t.toString())&&console.error("It seems you are using environment with Content Security Policy that prohibits unsafe-eval. The condition compiler from Antetype Conditions Module cannot work in this environment. Consider relaxing the policy to allow unsafe-eval or pre-compiling your templates into render functions. For now text based conditions are disabled."),!1}},m=k({inputsMap:I,herald:s,modules:u,inputsTypeMap:d,methodsMap:f,crud:h}),o=S({enableTextConditions:v(),inputsMap:I,herald:s,modules:u,crud:h});return{getInputsMap:()=>({...d}),getMethodsMap:()=>({...f}),...m,...h,...o,...y}}export{T as Event,x as actionLayerSymbol,E as changeActionSymbol,N as default,M as inputLayerSymbol};
